<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iris-polymer-importer/iris-importer.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">

<dom-module id="iris-queuelist">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
      }
    </style>
    <paper-card heading$="{{heading}}">
      <div class="card-content">
        <div class="counter">
          <content selector=".items-counter"></content>
        </div>
        <paper-button on-click="openList">
          <content class=".button-name"></content>
        </paper-button>
      </div>
      <paper-dialog id="dialog">
        <div>
          <paper-dialog-scrollable>
            <paper-listbox id="list">
              <paper-item class="field-names">
                <template is="dom-if" if="{{hasActions}}">
                  <span>Действие</span>
                </template>

                <span>№ талона</span>
                <span>Услуга</span>
                <span>Число дел</span>
                <span>ФИО</span>
                <span>Время ожидания</span>
              </paper-item>
              <template is="dom-repeat" items="{{queue_items}}" as="item">
                <paper-item on-tap="expandItem">
                  <template is="dom-if" if="{{hasActions}}">
                    <paper-button on-tap="ticketAction">Принять</paper-button>
                  </template>

                  <span>[[item.number]]</span>
                  <span>[[item.service]]</span>
                  <span>[[item.serices_count]]</span>
                  <span>{{computeName(item.fields)}}</span>
                  <span>{{computeWaitingTime(item.time_bounds)}}</span>
                </paper-item>
              </template>
            </paper-listbox>
          </paper-dialog-scrollable>

          <div class="buttons">
            <paper-button dialog-dismiss>Закрыть</paper-button>
          </div>
        </div>
      </paper-dialog>
    </paper-card>

  </template>

  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'iris-queuelist',
        properties: {
          api: Object,
          appState: Object,
          heading: String,
          listCount: Number,
          listName: String,
          hasActions: {
            type: Boolean,
            value: function() {
              return false;
            }
          }
        },
        ready() {

        },
        openList() {
          let queue = this.api.require('queue');
          let from = 0;
          let to = from + this.listCount;
          queue.listTickets(this.listName, from, to).then((result) => {
            this.queue_length = result.queue_length;
            this.queue_items = result.items;
          });
        },
        expandItem() {
          //@TODO: load history, etc.
          let selected = this.$.list.selected;

        },
        ticketAction() {
          let selected = this.$.list.selected;
        },
        computeName(fields) {
          let name = fields.name[0] + '.';
          let lastname = fields.lastname;
          let patronymic = fields.patronymic ? fields.patronymic[0] + '.' : '';
          return `${lastname} ${name} ${patronymic}`;
        },
        computeWaitingTime(time_bounds) {

        }
      });
    })();
  </script>

</dom-module>